{% extends 'base.html.twig' %}

{% block body %}
{% include 'security/menu.html.twig' %}

<h1>Se connecter</h1>

<div id="error-message" style="color:red;"></div>

<label for="username">Email ou Nom d'utilisateur</label>
<input type="text" id="username" required autofocus>
<br><br>

<label for="password">Mot de passe</label>
<input type="password" id="password" required>
<br><br>

<button id="login-btn">Se connecter</button>

<p>Pas encore de compte ?</p>
<a href="{{ path('app_register') }}" class="btn btn-success btn-lg">
    Créer un compte
</a>

<script>
document.getElementById('login-btn').addEventListener('click', async (e) => {
    e.preventDefault();
    const email = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    const res = await fetch('{{ path("app_api_login") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (res.ok) {
        console.log('Connecté ! Token :', data.apiToken);
        // Stocker le token pour les requêtes API suivantes
        localStorage.setItem('apiToken', data.apiToken);
        // Redirection après login
        window.location.href = '/'; 
    } else {
        document.getElementById('error-message').innerText = data.message;
    }
});
</script>
{% endblock %}
